name: ft_transcendence_prod # Different project name to avoid conflicts

services:
  # Caddy reverse proxy with TLS termination
  caddy:
    image: caddy:2-alpine
    container_name: ft_transcendence-caddy
    restart: unless-stopped
    ports:
      # Use unprivileged ports (no root required)
      # Access via https://localhost:8443 or https://mooo.com:8443
      - '8443:443' # HTTPS
      - '8080:80' # HTTP (redirects to HTTPS)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - transcendence-prod
    depends_on:
      - app

  app:
    container_name: ft_transcendence-prod
    # Pre-built image from GitHub Actions CI
    # image: ghcr.io/talkashi1111/ft_transcendence:latest
    # Always pull latest image from registry (see: https://docs.docker.com/reference/compose-file/services/#pull_policy)
    pull_policy: always
    # To build locally instead: uncomment build section and set pull_policy to 'build'
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    restart: unless-stopped
    volumes:
      - sqlite-data:/app/data
    networks:
      - transcendence-prod
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/data/database.db
      # Required secrets - set these before running!
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      # OAuth (optional - only if using Google login)
      # Note: OAUTH_CALLBACK_URI is auto-detected from request host
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      # Two-Factor Authentication (optional)
      - TWO_FACTOR_ENCRYPTION_KEY=${TWO_FACTOR_ENCRYPTION_KEY:-}
      # Blockchain (optional)
      - PRIVATE_KEY=${PRIVATE_KEY:-}
      - FUJI_RPC_URL=${FUJI_RPC_URL:-https://api.avax-test.network/ext/bc/C/rpc}
      - CONTRACT_ADDRESS=${CONTRACT_ADDRESS:-}
    # Internal port only - Caddy handles external traffic
    expose:
      - '3000'
    # Expose Prisma Studio for database inspection during defense
    # Access at http://localhost:5556 after running: docker exec -it ft_transcendence-prod npx prisma studio --url "file:/app/data/database.db" --browser none --port 5556
    ports:
      - '5556:5556'

volumes:
  sqlite-data:
  caddy_data:
  caddy_config:

networks:
  transcendence-prod:
