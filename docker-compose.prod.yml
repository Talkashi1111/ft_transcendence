name: ft_transcendence_prod # Different project name to avoid conflicts

services:
  # Caddy reverse proxy with TLS termination
  caddy:
    image: caddy:2-alpine
    container_name: ft_transcendence-caddy
    restart: unless-stopped
    ports:
      - '443:443' # HTTPS
      - '80:80' # HTTP (redirects to HTTPS)
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - transcendence-prod
    depends_on:
      - app

  app:
    container_name: ft_transcendence-prod
    # Pre-built image from GitHub Actions CI
    # To use latest: change tag to 'main-<commit-hash>' or use 'latest'
    # image: ghcr.io/talkashi1111/ft_transcendence:main-3e0c4e4
    image: ghcr.io/talkashi1111/ft_transcendence:latest
    # Uncomment to build locally instead of using pre-built image
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   target: production
    restart: unless-stopped
    volumes:
      - sqlite-data:/app/data
    networks:
      - transcendence-prod
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/data/database.db
      # Required secrets - set these before running!
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      # OAuth (optional - only if using Google login)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - OAUTH_CALLBACK_URI=${OAUTH_CALLBACK_URI:-https://mooo.com/api/oauth/google/callback}
      # Blockchain (optional)
      - PRIVATE_KEY=${PRIVATE_KEY:-}
      - FUJI_RPC_URL=${FUJI_RPC_URL:-https://api.avax-test.network/ext/bc/C/rpc}
      - CONTRACT_ADDRESS=${CONTRACT_ADDRESS:-}
    # Internal port only - Caddy handles external traffic
    expose:
      - '3000'

volumes:
  sqlite-data:
  caddy_data:
  caddy_config:

networks:
  transcendence-prod:
